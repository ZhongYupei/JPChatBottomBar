# JPChatBottomBar


> ä»Šå¤©ï¼Œæˆ‘ç»ˆäºæ›´æ›´æ›´æ›´åšäº†ã€‚
> æ¥ç€ä¸Šä¸€ç¯‡[èŠå¤©ç•Œé¢ä»0åˆ°1çš„å®ç° (ä¸€)](https://zhongyupei.github.io/2019/07/30/%E8%81%8A%E5%A4%A9%E7%95%8C%E9%9D%A2%E4%BB%8E0%E5%88%B01%E7%9A%84%E5%AE%9E%E7%8E%B0-%E4%B8%80/#more)ï¼Œ
> é¦–å…ˆæˆ‘ä»¬èŠä¸€èŠ èŠå¤©é¡µé¢çš„åº•éƒ¨æ¨ªæ¡ã€‚

<!--more-->

## å†™åœ¨å‰é¢

`JPChatBottomBar ` ä¸ç°åœ¨ä¸»æµçš„èŠå¤©é¡µé¢çš„åº•éƒ¨æ¨ªæ¡é¡µé¢ç›¸ä¼¼ã€‚
ç±»ä¼¼äºå¾®ä¿¡ä¸­çš„ï¼š
{% asset_img wechatBottomBar.jpg åº•éƒ¨æ¨ªæ¡ %}

ä¹‹æ‰€ä»¥å…ˆä»è¿™ä¸ªæ¨ªæ¡æ¥æŠ˜è…¾ï¼Œä¸ªäººæƒ³æ³•ï¼šä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œè¿™ä¸ªæ¨¡å—å¯ä»¥ä»Imä¸­ç‹¬ç«‹å‡ºæ¥ï¼Œä½†åˆå¯ä»¥å±è”½æ‰å› é€šä¿¡éƒ¨åˆ†ç¬¬ä¸‰æ–¹æœåŠ¡é€‰æ‹©çš„ä¸åŒè€Œå¸¦æ¥çš„å·®å¼‚ï¼ŒæœåŠ¡äºèŠå¤©çš„æ•´ä¸ªæ¡†æ¶ã€‚ä»¥åå¦‚æœæ¡†æ¶å‘ç”Ÿå˜åŒ–ï¼Œè¿™ä¸€æ¨¡å—å—åˆ°çš„å½±å“ä¹Ÿä¼šæ˜¯æœ€å°çš„ã€‚

`JPChatBottomBar`è™½ç„¶å¹¶ä¸æ•´ä¸ªæ¡†æ¶çš„æ ¸å¿ƒï¼Œä½†å´ä¹Ÿæä¾›ç€åŸºç¡€çš„æœåŠ¡åŠŸèƒ½â€”â€”ç¼–è¾‘æ¶ˆæ¯ã€‚
è‡ªå·±åœ¨æ¨¡ä»¿å®ç°ä¸€ä¸ªæ¨ªæ¡çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿé‡åˆ°äº†ä¸€äº›éº»çƒ¦ã€‚

ç¢äºç¯‡å¹…ï¼Œæ–‡ç« ä¸­ä¸»è¦ç”¨äºè®°å™ä¸€äº›æ¯”è¾ƒå¤æ‚çš„å®ç°æŠ‘æˆ–æ˜¯ä¸€äº›ç»†èŠ‚çš„é—®é¢˜ï¼Œç®€å•çš„é€»è¾‘åˆ¤æ–­å®ç°å°±ä¸å‡ºç°åœ¨è¿™é‡Œäº†ã€‚

demoçš„åœ°å€æ”¾åœ¨è¿™é‡Œï¼š[JPChatBottomBar--githubåœ°å€](https://github.com/ZhongYupei/JPChatBottomBar)

## åŠŸèƒ½åˆ†æ 
ç»“åˆå‰é¢çš„å›¾ï¼šå¯ä»¥åˆæ­¥æ€»ç»“å‡º `JPChatBottomBar` åº”è¯¥å®ç°çš„åŠŸèƒ½ï¼Œå¦‚ä¸‹ï¼š

-  1.é”®ç›˜çš„åˆ‡æ¢ï¼›
-  2.ç”¨æˆ·ç”Ÿæˆè¯­éŸ³æ¶ˆæ¯ï¼›
-  3.ç”¨æˆ·å¯¹æ–‡æœ¬æ¶ˆæ¯çš„æ“ä½œï¼ˆç¼–è¾‘ã€åˆ é™¤ã€å‘é€ï¼‰ï¼›
-  4.ç”¨æˆ·æ–‡æœ¬æ¶ˆæ¯ä¸­åµŒå…¥è¡¨æƒ…åŒ…ï¼›
-  5.ç”¨æˆ·ç‚¹å‡»äº†â€˜å¤§â€™è¡¨æƒ…åŒ…(ç±»ä¼¼äºä¸€äº›gifå›¾ç‰‡)ï¼›
-  6.ç”¨æˆ·ç‚¹å‡»æ›´å¤šæŒ‰é’®ï¼Œè¿›è¡Œé€‰æ‹©å…¶ä»–åŠŸèƒ½å®ç°ï¼ˆç±»ä¼¼å¾®ä¿¡ï¼šå›¾åº“ï¼Œæ‹æ‘„ï¼Œå‘é€åœ°å€ç­‰ç­‰ï¼‰ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡ ä¸€ä¸ªä»£ç† `JPChatBottomBarDelegate` æ¥å°†ç”¨æˆ·çš„æ“ä½œï¼ˆæ–‡æœ¬æ¶ˆæ¯ã€è¯­éŸ³æ¶ˆæ¯ç­‰ç­‰ï¼‰å‘å¤–ä¼ é€’ï¼Œå³å‘èŠå¤©æ¡†æ¶ä¸­çš„å…¶ä»–æ¨¡å—æä¾›æœåŠ¡ã€‚

å…ˆæ¥å¯¹æˆ‘æ‰€ä½¿ç”¨åˆ°çš„ç±»æ¥è¿›è¡Œè¯´æ˜:

- 1.`JPChatBottomBar ` :  æ•´ä¸ªæ¨ªæ¡
- 2.`preview`æ–‡ä»¶ä¸­çš„ç±»ç”¨äºå®ç°è¡¨æƒ…åŒ…çš„é¢„è§ˆæ•ˆæœ
- 3.`imageResource`æ–‡ä»¶å¤¹ä¸­å­˜æ”¾äº†æ­¤demoä¸­æ‰€ç”¨åˆ°çš„å›¾ç‰‡èµ„æº
- 4.`JPEmojiManager`ï¼šè¿™ä¸ªç±»ç”¨äºè¯»å–æ‰€æœ‰çš„è¡¨æƒ…åŒ…èµ„æº
- 5.`JPPlayerHelper`:è¿™ä¸ªç±»ç”¨äºå®ç°å½•éŸ³å’Œæ’­éŸ³çš„æ•ˆæœ
- 6.`JPAttributedStringHelper`:å®ç°è¡¨æƒ…åŒ…å­ç¬¦å’Œè¡¨æƒ…åŒ…å›¾ç‰‡çš„äº’è½¬
- 7.å…³äº`model`ï¼Œ`JPEmojiModel`ç”¨äºç»‘å®šå•ç‹¬ä¸€ä¸ªè¡¨æƒ…åŒ…ï¼Œ`JPEmojiGroupModel`ç”¨äºç»‘å®šä¸€æ•´ç»„çš„è¡¨æƒ…åŒ…ã€‚
- 8.`category`ä¸­å­˜æ”¾äº†ä¸€äº›å¸¸ç”¨çš„å·¥å…·ç±»

ä¸‹é¢ï¼Œè®©æˆ‘å°±ä¸Šé¢æ‰€ç½—åˆ—çš„åº”è¯¥å®ç°çš„åŠŸèƒ½ï¼Œæ¥è®²è®²å„åŠŸèƒ½æˆ‘æ˜¯å¦‚ä½•å®ç°æˆ–è€…æ˜¯åœ¨å®ç°çš„è¿‡ç¨‹ä¸­æˆ‘æ‰€é‡åˆ°çš„é—®é¢˜ã€‚

## é”®ç›˜åˆ‡æ¢
å…ˆçœ‹ä¸€ä¸‹æˆ‘æ‰€å®ç°çš„æ•ˆæœã€‚
{% asset_img jianpantanchu.gif  é”®ç›˜å¼¹å‡º,ä¸Šé¢çš„è§†å›¾å‘ä¸Šæ»‘åŠ¨%}

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨é”®ç›˜å¼¹å‡ºçš„è¿‡ç¨‹ä¸­ï¼Œ`controller.view`è¦å‘ä¸Šæ»‘åŠ¨ï¼Œé¿å…å¼¹å‡ºçš„é”®ç›˜é®æŒ¡ä½äº†ç”¨æˆ·çš„èŠå¤©é¡µé¢ã€‚è¿™ä¹Ÿæ˜¯éå¸¸åŸºç¡€çš„åŠŸèƒ½ã€‚

è€Œå…³äºé”®ç›˜çš„å®ç°æˆ‘å¹¶æ²¡æœ‰é€šè¿‡ä»¥å¾€å¸¸ç”¨çš„ç›‘å¬é”®ç›˜å¼¹å‡ºé€šçŸ¥åè°ƒç”¨æ–¹æ³•æ¥è¿›è¡Œè§†å›¾çš„è°ƒæ•´ã€‚è¿™é‡Œçš„å®ç°ï¼Œæˆ‘é‡‡ç”¨çš„æ˜¯kvoçš„æ–¹å¼ï¼Œæˆ‘ç›‘å¬`textView.inputView`çš„åˆ‡æ¢ã€‚

ä¹‹æ‰€ä»¥ä¸é‡‡ç”¨`keyboardWillShow:`çš„æ–¹æ³•è€Œæ˜¯é‡‡ç”¨KVOçš„å½¢å¼ï¼Œä¸»è¦åŸå› å¦‚ä¸‹ï¼š

åœ¨åˆ‡æ¢é”®ç›˜çš„æ—¶å€™ï¼Œä¾‹å¦‚ä»è¡¨æƒ…åŒ…é”®ç›˜åˆ‡æ¢åˆ°ç³»ç»Ÿé”®ç›˜çš„è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿé”®ç›˜çš„é«˜åº¦æ˜¯å¤§äºè¡¨æƒ…åŒ…é”®ç›˜çš„ï¼Œè¿™æ—¶å€™ç³»ç»Ÿé”®ç›˜å¹¶ä¸ä¼šä»åº•éƒ¨ç›´æ¥å¼¹å‡ºæ¥ï¼Œè€Œæ˜¯è¿˜æ²¡æœ‰ç­‰åˆ°æˆ‘ä»¬çš„`chatBottomBar`æ»‘ä¸Šå»ä¹‹å‰å°±å°†å…¶è¦†ç›–æ‰ï¼Œæ•ˆæœå¯ä»¥å‚è€ƒå¦‚ä¸‹:
{% asset_img jianpanfugai.gif è¡¨æƒ…é”®ç›˜è½¬æ¢æˆç³»ç»Ÿé”®ç›˜æ—¶å€™æœ‰ä¸€å°éƒ¨åˆ†è¦†ç›– %}

è€Œåœ¨è§‚å¯Ÿäº†å¾®ä¿¡é”®ç›˜åˆ‡æ¢çš„å®ç°æ•ˆæœï¼Œæ˜¯æ²¡æœ‰è¿™ç§è¦†ç›–æ•ˆæœï¼Œæœ‰ç‚¹å¿å—ä¸äº†è¿™ç§è¦†ç›–ï¼Œäºæ˜¯æˆ‘å°±é‡‡ç”¨äº†kvoçš„å½¢å¼æ¥å®ç°ï¼Œè·å–`textView.inputView`æ–°æ—§å€¼çš„å˜åŒ–ï¼Œæ¥è·å–æ–°è€Viewä¹‹é—´é«˜åº¦çš„å·®å€¼ï¼Œä»è€Œè°ƒæ•´æ•´ä¸ªè§†å›¾ã€‚å®ç°ä»£ç å¦‚ä¸‹

```
// JPChatBottomBar.m
// ç›‘å¬textView.inputViewå±æ€§æ–°æ—§å€¼çš„å˜åŒ–

[_textView addObserver:self forKeyPath:@"inputView" options:NSKeyValueObservingOptionOld|NSKeyValueObservingOptionNew context:nil];
- (void)emojiViewPop:(UIButton *)button {
	///åˆ‡æ¢æˆè¡¨æƒ…åŒ…é”®ç›˜
    if(_keyBoardState == JPKeyBoardStateEmoji)      return;
    _keyBoardState = JPKeyBoardStateEmoji;
    if(_isAudioState) {
        [self emojiAndMoreStateToTextViewState];
    }
    self.textView.inputView = self.emojiIV;	/// åˆ‡æ¢é”®ç›˜
    self.textView.editable = NO;
}
/// å›è°ƒæ–¹æ³•(KVO)
- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary<NSKeyValueChangeKey,id> *)change context:(void *)context {
  if([keyPath isEqualToString:@"inputView"] && object == self.textView ){
        UIView * freshView = [change objectForKey:@"new"];
        if(![freshView isKindOfClass:[NSNull class]] && self.keyBoardState != JPKeyBoardStateTextView) {
            // åˆ‡æ¢æˆäº†étextViewçš„æ¨¡å¼
            self.textView.editable = YES;
            [UIView setAnimationCurve:UIViewAnimationCurveEaseOut];
            [UIView animateWithDuration:0.3 animations:^{
                self.superview.y =  - freshView.height;
            } completion:^(BOOL finished) {
                [self.textView reloadInputViews];
                [self.textView becomeFirstResponder];
                self.textView.editable = NO;
            }];
        }else if([freshView isKindOfClass:[NSNull class]] && self.keyBoardState == JPKeyBoardStateTextView){
            self.textView.editable = YES;
            [UIView setAnimationCurve:UIViewAnimationCurveEaseOut];
            [UIView animateWithDuration:0.3 animations:^{
                self.superview.y = - [UIView jpDefaultKeyboardHeight];
            } completion:^(BOOL finished) {
                [self.textView reloadInputViews];
                [self.textView becomeFirstResponder];
            }];
        }
    }
```
ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç­‰åˆ°`chatBottomBar`åˆ°è¾¾äº†è¯¥åˆ°çš„ä½ç½®ä¹‹åï¼Œå†è°ƒç”¨`-textView reloadInputView`æ¥å”¤é†’é”®ç›˜ã€‚å¦‚æ­¤å°±å¯ä»¥è¾¾åˆ°é”®ç›˜ä»ä¸‹å¼¹å‡ºå¹¶ä¸”ä¸ä¼šæœ‰å°éƒ¨åˆ†è¦†ç›–çš„æ•ˆæœã€‚
**å…¶æ¬¡æœ‰ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹**ï¼Œåœ¨åˆ‡æ¢é”®ç›˜çš„æ—¶å€™ï¼Œéœ€è¦å°†`textView.editable`è®¾ç½®ä¸ºnoï¼Œå¦åˆ™è¾¾ä¸åˆ°åˆ‡æ¢çš„æ•ˆæœã€‚

å…³äºé”®ç›˜çš„åˆ‡æ¢å‰©ä¸‹çš„å°±æ˜¯ æ ¹æ®ç”¨æˆ·çš„ç‚¹å‡»åˆ‡æ¢é”®ç›˜çš„çŠ¶æ€ï¼ˆå˜åŒ–ç›¸åº”çš„è§†å›¾ï¼‰ã€‚
è¿™ä¸€éƒ¨åˆ†å°±å…ˆåˆ°æ­¤â˜ºï¸ğŸ‘ŒğŸ¾ã€‚

## è¯­éŸ³æ¶ˆæ¯
åœ¨å‚è€ƒäº†åˆ«äººçš„Demo([iOSä»¿å¾®ä¿¡å½•éŸ³æ§ä»¶Demo](https://www.jianshu.com/p/37f62d568b71))ä¹‹åï¼Œæˆ‘ä¹Ÿå®ç°äº†ä¸€ä¸ªã€‚

å…ˆç»™å‡ºè‡ªå·±æ‰€ä½¿ç”¨çš„ç±»çš„ä»‹ç»ï¼š
- 1.`JPPlayerHelper`  : å®ç°å½•éŸ³å’Œæ’­éŸ³çš„åŠŸèƒ½ã€‚
- 2.`JPAudioView`: å±•ç¤ºå½•éŸ³çš„çŠ¶æ€

è®©æˆ‘æ¦‚æ‹¬ä¸€ä¸‹ å®ç°çš„å¤§æ¦‚æ­¥éª¤ã€‚
é¦–å…ˆä¸¤ä¸ªç±»ä¹‹é—´å¹¶ä¸æ˜¯ç›¸äº’ä¾èµ–çš„ï¼Œä¸¤è€…åœ¨`JPChatBottomBar`ä¸­äº§ç”Ÿè€¦åˆã€‚

### ä¸Šæ»‘å–æ¶ˆã€ä¸‹æ»‘ç»§ç»­å½•éŸ³çš„æ•ˆæœ
æˆ‘åœ¨JPAudioViewä¸­åˆ©ç”¨äº†ä¸‹é¢ç€ä¸‰ä¸ªæ–¹æ³•æ¥è®©audioViewå¯¹ç”¨æˆ·æ‰‹åŠ¿å˜åŒ–è¿›è¡Œåˆ¤æ–­(å¼€å§‹ç‚¹å‡»ã€å‘ä¸Šå‘ä¸‹æ»‘åŠ¨ã€æ‰‹æŒ‡ç¦»å¼€)ï¼Œå¹¶ä½œå‡ºç›¸åº”çš„å¤„ç†ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event;
- (void)touchesMoved:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event ;
- (void)touchesEnded:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event;
```
åœ¨ä¸Šé¢è¿™ä¸‰ä¸ªæ–¹é¢ä¸­è§£å†³è‡ªèº«çš„UIé—®é¢˜ï¼Œå†é€šè¿‡blockä»å¤–éƒ¨æ¥å®ç°å½•éŸ³ä»¥åŠæ ¹æ®è¯­éŸ³å¼ºåº¦æ›´æ–°UIçš„æ•ˆæœï¼š

```
/// AudioView blockå—çš„å®ç°(JPChatBottomBar.m)
- (JPAudioView *)audioView {
    if(!_audioView) {
        JPAudioView * tmpView = [[JPAudioView alloc] initWithFrame:CGRectMake(self.textView.x, self.textView.y, self.textView.width,  _btnWH )];
        [self addSubview:tmpView];
        _audioView = tmpView;
        // å®ç°audioViewçš„æ–¹æ³•
        __weak typeof (self) wSelf = self;
        _audioView.pressBegin = ^{
            [wSelf.audioView setAudioingImage:[UIImage imageNamed:@"zhengzaiyuyin_1"] text:@"æ¾å¼€æ‰‹æŒ‡ï¼Œä¸Šæ»‘å–æ¶ˆ"];
            // å¼€å§‹å½•éŸ³
            [wSelf.recoder jp_recorderStart];
        };
        _audioView.pressingUp = ^{
            [wSelf.audioView setAudioingImage:[UIImage imageNamed:@"songkai"] text:@"æ¾å¼€æ‰‹æŒ‡ï¼Œå–æ¶ˆå‘é€"];
        };
        _audioView.pressingDown = ^{
            NSString * imgStr = [NSString stringWithFormat:@"zhengzaiyuyin_%d",imageIndex];
            [wSelf.audioView setAudioingImage:[UIImage imageNamed:imgStr] text:@"æ¾å¼€å‘é€ï¼Œä¸Šæ»‘å–æ¶ˆ"];
        };
        _audioView.pressEnd = ^{
            [wSelf.audioView setAudioViewHidden];
            [wSelf.recoder jp_recorderStop];
            NSString * filePath = [wSelf.recoder getfilePath];
            NSData * audioData = [NSData dataWithContentsOfFile:filePath];
            /// å°†è¯­éŸ³æ¶ˆæ¯dataé€šè¿‡ä»£ç†å‘å¤–ä¼ é€’
            if(wSelf.agent && [wSelf.agent respondsToSelector:@selector(msgEditAgentAudio:)]){
                [wSelf.agent msgEditAgentAudio:audioData];
            }
            if(wSelf.msgEditAgentAudioBlock){
                wSelf.msgEditAgentAudioBlock(audioData);
            }
        };
    }
    return _audioView;
}
```
å…¶æ¬¡å°±æ˜¯è¿™ä¸€å—æ¯”è¾ƒå…³é”®çš„ç‚¹ï¼š
***æ ¹æ®è¯­éŸ³çš„å¼ºåº¦æ¥åˆ·æ–°audioViewçš„UI***

å‚è§æ•ˆæœå¦‚ä¸‹ï¼š
{% asset_img yuyinshuaxin.gif åˆ†è´å¼ºåº¦UIçš„åˆ·æ–°%}

æˆ‘ä»¬é¦–å…ˆè·å–è¯­éŸ³å¼ºåº¦å¹³å‡å€¼çš„æ–¹æ³•ä¸»è¦é€šè¿‡ï¼š

```
/// æ›´æ–°æµ‹é‡å€¼
- (void)updateMeters; /* call to refresh meter values */
/// è·å–å³°å€¼
- (float)peakPowerForChannel:(NSUInteger)channelNumber; 
/// è·å–å¹³å‡å€¼
- (float)averagePowerForChannel:(NSUInteger)channelNumber; 
```
***åœ¨è·å–è¯­éŸ³å¼ºåº¦çš„æ—¶å€™ï¼Œéœ€è¦å…ˆ`updateMeters`æ›´æ–°ä¸€ä¸‹æµ‹é‡å€¼ã€‚***
ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡æµ‹é‡å€¼ ã€ å³°å³°å€¼ä¹‹åï¼Œæ ¹æ®ä¸€å®šçš„ç®—æ³•æ¥è®¡ç®—å‡ºæ­¤æ—¶å£°éŸ³çš„ç›¸å¯¹å¤§å°å¼ºåº¦ã€‚è¿™é‡Œï¼Œç®—æ³•å¾ˆåƒåœ¾çš„æˆ‘ç®€å•çš„è®¾è®¡äº†ä¸€ä¸ª:

```
// JPPlayerHelper.m
- (CGFloat)audioPower {
    [self.recorder updateMeters];           // æ›´æ–°æµ‹é‡å€¼
    float power = [self.recorder averagePowerForChannel:0];     // å¹³å‡å€¼ å–å¾—ç¬¬ä¸€ä¸ªé€šé“çš„éŸ³é¢‘ï¼Œæ³¨æ„éŸ³é¢‘çš„å¼ºåº¦ä¸º[-160,0],0æœ€å¤§
//    float powerMax = [self.recorder peakPowerForChannel:0];
//    CGFloat progress = (1.0/160.0) * (power + 160);
    power = power + 160 - 50;
    int dB = 0;
    if (power < 0.f) {
        dB = 0;
    } else if (power < 40.f) {
        dB = (int)(power * 0.875);
    } else if (power < 100.f) {
        dB = (int)(power - 15);
    } else if (power < 110.f) {
        dB = (int)(power * 2.5 - 165);
    } else {
        dB = 110;
    }
    return dB;
}
```
> å…³äºè¿™ä¸€å—çš„ç®—æ³•ï¼Œå¦‚æœå„ä½è¯»è€…æœ‰æ›´å¥½çš„æ–¹æ³•ï¼Œæ¬¢è¿æå‡ºï¼Œæˆ‘ä¹Ÿæ˜¯ä¸ªæ¸´æœ›çŸ¥è¯†çš„å°ç™½ã€‚

é€šè¿‡ä¸Šé¢çš„æ–¹æ³•å¯ä»¥è·å–ç›¸åº”çš„å£°éŸ³çš„åˆ†è´å¼ºåº¦ï¼Œæˆ‘ä»¬å¤–éƒ¨å¯ä»¥åšä¸€äº›å¤„ç†ï¼šä¾‹å¦‚æˆ‘åšäº†ï¼Œå½“æ–°æµ‹é‡å€¼æ¯”æ—§çš„æµ‹é‡å€¼å¤§ä¸€å®šå€¼çš„æ—¶å€™ï¼Œå°±åšæé«˜åˆ†è´çš„UIåˆ·æ–°æ“ä½œï¼Œä½çš„æ—¶å€™å°±åšé™ä½åˆ†è´UIçš„æ“ä½œï¼Œå…·ä½“å¯ä»¥çœ‹ä¸‹é¢çš„ä»£ç ï¼š

```
// JPChatbottomBar.m
- (void) jpHelperRecorderStuffWhenRecordWithAudioPower:(CGFloat)power{
    NSLog(@"%f",power);
    NSString * newPowerStr =[NSString stringWithFormat:@"%f",[self.helper audioPower]];
    if([newPowerStr floatValue] > [self.audioPowerStr floatValue]) {
        if(imageIndex == 6){
            return;
        }
        imageIndex ++;
    }else {
        if(imageIndex == 1){
            return;
        }
        imageIndex --;
    }
    if(self.audioView.state == JPPressingStateUp) {
        self.audioView.pressingDown();
    }
    self.audioPowerStr =  newPowerStr;;
}
```

å…¶æ¬¡ï¼Œæˆ‘åœ¨`JPPlayerHepler`åŠ äº†ä¸€ä¸ªè®¡æ—¶å™¨æ¥è§¦å‘åå¤è°ƒç”¨ä¸Šé¢çš„ä»£ç†æ–¹æ³•(` - (void) jpHelperRecorderStuffWhenRecordWithAudioPower:(CGFloat)power `) ï¼Œè®©å…¶å¯ä»¥è¿›è¡ŒUIçš„åˆ·æ–°ï¼Œå› ä¸ºå¦‚æœä¸åŠ è®¡æ—¶å™¨ï¼Œæˆ‘ä»¬æ˜¯æ²¡æœ‰äº‹ä»¶å»è§¦å‘`audioView `UIåˆ·æ–°çš„æ“ä½œï¼Œè®¡æ—¶å™¨ç›¸å…³æ–¹æ³•å¦‚ä¸‹:

```
// JPPlayerHelper.m
-(NSTimer *)timer{
    if (!_timer) {
        _timer=[NSTimer scheduledTimerWithTimeInterval:0.35 target:self selector:@selector(doOutsideStuff) userInfo:nil repeats:YES];
    }
    return _timer;
}
- (void)doOutsideStuff {
    
    if(self.delegate && [self.delegate respondsToSelector:@selector(jpHelperRecorderStuffWhenRecordWithAudioPower:)]){
        [self.delegate jpHelperRecorderStuffWhenRecordWithAudioPower:[self audioPower]];
    }
}
```
å®Œæˆå½•éŸ³ä¹‹åï¼Œæœ€ç»ˆæˆ‘ä»¬çš„è¯­éŸ³æ•°æ®é€šè¿‡`JPChatBottomBarDelegate`çš„ä»£ç†æ–¹æ³•å‘å¤–æä¾›ã€‚

å…³äºè·å–è¯­éŸ³å¼ºåº¦é‚£ä¸€å—çš„ç®—æ³•å¹¶ä¸æ˜¯æœ€ä¼˜ï¼Œæˆ‘è§‰å¾—æˆ‘çš„ç®—æ³•ä¹Ÿæ˜¯æ¯”è¾ƒç¬¨æ‹™å­˜åœ¨ç¼ºç‚¹ï¼ˆå¯¹ç”¨æˆ·è¯­éŸ³å¼ºåº¦çš„å˜åŒ–ä¸æ•æ„Ÿï¼‰ã€‚å¦‚æœè·¯è¿‡çš„è¯»è€…æœ‰ä»€ä¹ˆä¸é”™çš„å»ºè®®ï¼Œæ¬¢è¿æå‡ºè¡¥å……ï¼Œæˆ‘ä¹Ÿä¼šé‡‡çº³ï¼Œè°¢è°¢ğŸ™ğŸ™ğŸ™ã€‚

## 'æ›´å¤š' é”®ç›˜ ä¸Šé¢çš„Item
`JPChatBottomBar`é‡Œé¢çš„â€˜æ›´å¤šâ€™é”®ç›˜ä¸å¾®ä¿¡çš„ç±»ä¼¼ã€‚
{% asset_img gengduojianpan.jpg â€˜æ›´å¤šâ€™é”®ç›˜%}
å¼€å‘è€…åœ¨ä½¿ç”¨çš„æ—¶å€™å¦‚æœæƒ³è¦é”®å…¥ä¸åŒçš„åŠŸèƒ½å®ç°ï¼Œåªè¦åœ¨`/ImageResource/JPMoreBundle.bundle` çš„`JPMorePackageList.plist`æ–‡ä»¶ä¸­æ·»åŠ ç›¸åº”çš„item

{% asset_img gengduojianpanplistyemian.jpg JPMorePackageList.plistå±•ç¤º%}

> å†…éƒ¨ä¹Ÿå·²ç»åšå¥½äº†é€‚é…çš„æ•ˆæœï¼Œä¸è¿‡å½“itemæ•°é‡è¶…è¿‡8ä¸ªæ—¶å€™ï¼Œæ²¡æœ‰å®Œæˆåƒå¾®ä¿¡çš„é‚£ç§åˆ†é¡µæ•ˆæœï¼ŒåæœŸæˆ‘ä¼šç»§ç»­å®Œå–„ã€‚

å½“ç”¨æˆ·ç‚¹å‡»äº†ä¸Šé¢çš„æŸä¸ªitemä¹‹åï¼Œæˆ‘ä»¬å°±å°†äº‹ä»¶é€šè¿‡`JPChatBottomBarDelegate`å‘å¤–é¢ä¼ é€’ï¼Œå¼€å‘è€…å¯ä»¥å†æœ€å¤–å±‚åšå¤„ç†ï¼Œæ ¹æ®ç‚¹å‡»å“ªä¸ªitemå“åº”ç›¸åº”çš„æ–¹æ³•åŠŸèƒ½ï¼Œç±»ä¼¼å¦‚ä¸‹ä»£ç ï¼š

```
// ViewController.m
NSString * kJPDictKeyImageStrKey = @"imageStr";
- (void)msgEditAgentClickMoreIVItem:(NSDictionary *)dict {
    NSString * judgeStr = dict[kJPDictKeyImageStrKey];
    if([judgeStr isEqualToString:@"photo"]){
        NSLog(@"ç‚¹å‡»äº†å›¾å†Œ");
    }else if([judgeStr isEqualToString:@"camera"]){
        NSLog(@"ç‚¹å‡»äº†æ‘„åƒå¤´");
    }else if([judgeStr isEqualToString:@"file"]) {
        NSLog(@"ç‚¹å‡»äº†æ–‡ä»¶");
    }else if([judgeStr isEqualToString:@"location"]) {
        NSLog(@"ç‚¹å‡»äº†ä½ç½®");
    }
}
```

ä¸€å¼€å§‹æ²¡æœ‰æƒ³ç€å°†ç”¨æˆ·ç‚¹å‡»å“ªä¸ªitemæš´éœ²åœ¨å¤–é¢ï¼Œä½†åæ¥æƒ³äº†å¼€å‘è€…é¢ä¸´çš„ä¸šåŠ¡å¤šç§å¤šæ ·ï¼Œitemçš„æ’å¸ƒä¹Ÿä¸ä¸€æ ·ï¼Œä¸ºäº†æ›´å¥½çš„æ‰©å±•ï¼Œç®€åŒ–`JPChatBottomBar`çš„ç»“æ„ï¼Œå°±å°†è¿™éƒ¨åˆ†ä¹Ÿé€šè¿‡ä»£ç†å†™å‡ºæ¥ã€‚

## æ–‡æœ¬æ¶ˆæ¯çš„ç¼–è¾‘ï¼ˆå‘é€ã€åˆ é™¤ã€åµŒå…¥è¡¨æƒ…åŒ…æ–‡æœ¬ï¼‰
> 
> 



## å†™åœ¨æœ€å
## å‚è€ƒ
































